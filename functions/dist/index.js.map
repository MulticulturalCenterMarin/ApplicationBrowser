{"version":3,"sources":["../src/index.js"],"names":["_","require","functions","admin","stripe","config","token","twilio","VoiceResponse","twiml","shortid","moment","db","initializeApp","firebase","firestore","currency","accountSid","accountsid","authToken","authtoken","twilioClient","graphQLServer","exports","api","https","onRequest","dataFlow","document","onCreate","console","log","event","data","params","userId","dataFlows","authenticationComplete","auth","user","eid","uid","images","imageProfile","photoURL","name","nameDisplay","displayName","nameFirst","contact","contactEmail","email","provider","providerData","collection","add","person","authenticationUserOnCreate","database","ref","key","databaseWrite","writeType","entity","branches","pointer","payload","mutateRequest","val","metadata","hotlineDepartment","branch","omit","days","match","length","time","dateEnd","epochToday","dayendEpoch","Date","get","hourStart","currentHour","activeReferenceHotline","once","then","value","twilioVoice","voiceResponse","dial","activeVolunteers","forEach","number","volunteer","contactPhone","response","send","toString","twilioSmsMonitorOutbound","generate","smsRequest","timestamp","dataKey","twilioSyncCalls","calls","each","direction","call","duration","forwardedFrom","from","fromFormatted","endTime","phoneNumberSid","startTime","status","to","toFormatted","price","twilioSyncMessages","messages","body","message","errorCode","errorMessage","numMedia","sid","priceUnit","uri","createStripeCustomer","customers","create","customer","id","addPaymentSource","onWrite","snapshot","createSource","source","adminRef","parent","set","child","userFacingMessage","error","reportError","cleanupUser","onDelete","del","customer_id","remove"],"mappings":"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","file":"index.js","sourcesContent":["/* ------------------------ External Dependencies ------------------------ */\nconst _ = require('lodash')\nconst functions = require('firebase-functions');\nconst admin = require('firebase-admin');\nconst stripe = require('stripe')(functions.config().stripe.token);\nconst twilio = require('twilio');\nconst VoiceResponse = require('twilio').twiml.VoiceResponse;\nconst shortid = require('shortid'); // https://www.npmjs.com/package/shortid\nconst moment = require('moment-timezone')\n/* ------------------------- Internal Dependencies -------------------------- */\nconst db = require('./database');\nimport setupGraphQLServer from './graphql'\nimport { twilioTextSend } from './twilio'\nimport { transformUserOnCreate } from './schema/transform'\n/*--- Third-Party Integrations ---*/\nimport todayEpoch from './timewatch/todayEpoch'\nimport todayMatch from './timewatch/todayMatch'\n/* ------------------------ Initialize Dependencies ------------------------- */\nadmin.initializeApp(functions.config().firebase);\nconst firestore = admin.firestore();\n\n// Stripe\nconst currency = functions.config().stripe.currency || 'USD';\n\n// Twilio\nconst accountSid = functions.config().twilio.accountsid\nconst authToken = functions.config().twilio.authtoken\nconst twilioClient = new twilio(accountSid, authToken);\n/*---*---------------              ---------------*---* \n                         GraphQL \n/*---*---------------              ---------------*---*/\nconst graphQLServer = setupGraphQLServer()\nexports.api = functions.https.onRequest(graphQLServer)\n\n\n/*---*---------------              ---------------*---* \n                         Data Flow\n/*---*---------------              ---------------*---*/\nexports.dataFlow = functions.firestore\n  .document('customers/{customer}').onCreate((event) => {\n    console.log(event)\n    console.log(event.data)\n    console.log(event.params)\n    console.log(event.params.userId)\n  });\nexports.dataFlows = functions.firestore\n  .document('articles/{article}').onCreate((event) => {\n    console.log(event)\n    console.log(event.params)\n    console.log(event.params.userId)\n  });\n\n/*---*---------------              ---------------*---* \n                      Authentication \n/*---*---------------              ---------------*---*/\nexports.authenticationComplete = functions.auth.user().onCreate(event => {\n  const person = {\n    eid: event.data.uid,\n    images: {\n      imageProfile: event.data.photoURL\n    },\n    name: {\n      nameDisplay: event.data.displayName,\n      nameFirst: event.data.displayName,\n    },\n    contact: {\n      contactEmail: event.data.email,\n    },\n    provider: event.data.providerData,\n  }\n  firestore.collection('people').add(person)\n});\n\nexports.authenticationUserOnCreate = functions.database.ref('/users/{user}')\n  .onCreate(event => {\n    const pointer = event.data.key \n\n    \n    db.databaseWrite({\n      config: {writeType: 'update'},\n      entity: 'users',\n      branches: [pointer],\n      payload: {pointer},\n    })\n  })\n\n/*---*---------------              ---------------*---* \n                         Mutate\n/*---*---------------              ---------------*---*/\nexports.mutateRequest = functions.database.ref('/mutate/request/{request}')\n\n  /*--- Monitor User Create | Insert additional User data.   (DB Middleware?)   ---*/\n  .onCreate(event => {\n    const eventKey = event.data.key \n    const data = event.data.val()\n\n    /* Entity | Target the requested entity to mutate */\n    if(data.metadata.entity) {\n      switch(data.metadata.entity) {\n\n        /* Volunter Hotline */\n        case('volunteerHotline'):\n          // TODO Add additional verification, besides just existing. It needs to match an enabled hotline.\n          if(data.metadata.hotlineDepartment)\n          {\n            db.databaseWrite({\n              config: {writeType: 'push'},\n              entity: 'volunteer',\n              branch: ['hotline', data.metadata.hotlineDepartment, 'storage'],\n              payload: _.omit(data.payload, 'userRequesting'),\n            })\n            const match = todayMatch(data.payload.days)\n            if (match.length){\n              const epochToday = todayEpoch(\"America/Los_Angeles\")\n              if (data.payload.time.dateEnd >= epochToday.dayendEpoch)\n              {\n                db.databaseWrite({\n                  config: {writeType: 'push'},\n                  entity: 'volunteer',\n                  branch: ['hotline', 'immigration', 'today'],\n                  payload: data.payload,\n                })\n\n                let currentHour = moment(new Date(),\"America/Los_Angeles\").get('hour'); const nextHour = currentHour + 1\n                if (data.payload.time.hourStart <= currentHour)\n                {\n                  const activeReferenceHotline = admin.database().ref('/volunteer/hotline/immigration/active')\n                  activeReferenceHotline.once('value').then(value => {\n                    let newValue = value.val()\n                    db.databaseWrite({\n                      config: {writeType: 'push'},\n                      entity: 'volunteer',\n                      branch: ['hotline', 'immigration', 'active'],\n                      payload: data.payload,\n                    })\n                  })\n                }\n              } \n            }\n          }\n          break;\n      }\n    }\n  })\n\n/* -------------------------------------------------------------------------- */\n/* ------------------------- External API Services -------------------------- */\n/* -------------------------------------------------------------------------- */\n\n/*---*---               ---*---* \n            Twilio\n            https://www.twilio.com/docs/api/twiml/client\n*---*---               ---*---*/\nexports.twilioVoice = functions.https.onRequest((request,response)=> {\n  const voiceResponse = new VoiceResponse();\n  const dial = voiceResponse.dial();\n  const activeReferenceHotline = admin.database().ref('/volunteer/hotline/immigration/active')\n  activeReferenceHotline.once('value').then(activeVolunteers => {\n    const data = activeVolunteers.val()\n    _.forEach(data, volunteer=>{\n      dial.number(`1${volunteer.contact.contactPhone}`)\n    })\n  response.send(voiceResponse.toString())\n  })\n})\n\n\n/*---*---               ---*---* \n            Twilio\n            https://www.twilio.com/docs/api/twiml/client\n*---*---               ---*---*/\nexports.twilioSmsMonitorOutbound = functions.database.ref('/infrastructure/messages/outbound/request/{messages}')\n  .onCreate(event => {\n      const dataKey = event.data.key // SMS Request Key | Generated by Firebase\n      const smsRequest = event.data.val(); // SMS Request Values | Latest Child from onCreate\n\n      /**\n       * @todo We need to add more PERMISSIONS CHECKS for SMS enhanced security.\n       * In addition the system should monitor for attempts to abuse SMS services, either by tracking volume or\n       * doing multiple verifications and looking for abnormalities in frontend/backend security checks.\n       * \n       * We trust cookies and Firebase, but \n       * \n       * Steps for Security\n       * 1. The Database rules limits who can write to the infrastructure \n       */\n      if (true) {      \n        const uid = shortid.generate(); // Universal Identification\n        smsRequest.metadata.uid = uid\n        smsRequest.metadata.timestamp = new Date()\n        /*--- DatabaseWrite | Infrastructure Communication Message Outbound Request ---*/ \n        /**\n         * Add a Universal Identifier to the Request\n         */\n        db.databaseWrite({\n          entity: 'infrastructure',\n          branch: ['messages', 'outbound', 'request', dataKey],\n          payload: {uid},\n          config: {\n            writeType: 'update'\n          }\n        })\n        \n        /**\n         * Log the SMS \n         */\n        db.databaseWrite({\n          entity: 'activity',\n          branch: ['sms'],\n          payload: {smsRequest},\n          config: {\n            writeType: 'push'\n          }\n        })\n\n        const payload = smsRequest.payload\n        twilioTextSend(uid, payload)\n      }\n  });\n\nexports.twilioSyncCalls = functions.https.onRequest((request,response)=> {\n  twilioClient.calls\n    .each((call) => {\n      const t = firestore.collection('calls').add({\n        direction: call.direction,\n        duration: call.duration,\n        forwardedFrom: call.forwardedFrom,\n        from: call.from,\n        fromFormatted: call.fromFormatted,\n        endTime: call.endTime,\n        phoneNumberSid: call. phoneNumberSid,\n        startTime: call.startTime,\n        status: call.status,\n        to: call.to,\n        toFormatted: call.toFormatted,\n        price: call.price,\n      })\n    });\n    response.send('Syncing Calls') \n})\n\nexports.twilioSyncMessages = functions.https.onRequest((request,response)=> {\n  twilioClient.messages\n    .each((message) => {\n      firestore.collection('messages').add({\n        body: message.body,\n        direction: message.direction,\n        errorCode: message.errorCode,\n        errorMessage: message.errorMessage,\n        from: message.from,\n        numMedia: message.numMedia,\n        status: message.status,\n        sid: message.sid,\n        to: message.to,\n        price: message.price,\n        priceUnit: message.priceUnit,\n        uri: message.uri,\n      })\n    });\n})\n\n\n/*---*---               ---*---* \n            Stripe\n            https://github.com/firebase/functions-samples/blob/master/stripe/functions/index.js\n*---*---               ---*---*/\n\n// When a user is created, register them with Stripe\nexports.createStripeCustomer = functions.auth.user().onCreate(event => {\n  const data = event.data;\n  return stripe.customers.create({\n    email: data.email\n  }).then(customer => {\n    firestore.collection('customers').add({\n        eid: customer.id\n      })\n  });\n});\n\n// Add a payment source (card) for a user by writing a stripe payment source token to Realtime database\nexports.addPaymentSource = functions.database.ref('/stripe_customers/{userId}/sources/{pushId}/token').onWrite(event => {\n  const source = event.data.val();\n  if (source === null) return null;\n  return admin.database().ref(`/stripe_customers/${event.params.userId}/customer_id`).once('value').then(snapshot => {\n    return snapshot.val();\n  }).then(customer => {\n    return stripe.customers.createSource(customer, {source});\n  }).then(response => {\n      return event.data.adminRef.parent.set(response);\n    }, error => {\n      return event.data.adminRef.parent.child('error').set(userFacingMessage(error)).then(() => {\n        return reportError(error, {user: event.params.userId});\n      });\n  });\n});\n\n// When a user deletes their account, clean up after them\nexports.cleanupUser = functions.auth.user().onDelete(event => {\n  return admin.database().ref(`/stripe_customers/${event.data.uid}`).once('value').then(snapshot => {\n    return snapshot.val();\n  }).then(customer => {\n    return stripe.customers.del(customer.customer_id);\n  }).then(() => {\n    return admin.database().ref(`/stripe_customers/${event.data.uid}`).remove();\n  });\n});\n"]}