{"version":3,"sources":["../src/index.js"],"names":["_","require","functions","admin","stripe","twilio","VoiceResponse","twiml","shortid","moment","db","initializeApp","config","firebase","firestore","accountSid","accountsid","authToken","authtoken","twilioClient","graphQLServer","exports","api","https","onRequest","authenticationComplete","auth","user","onCreate","uid","event","data","images","imageProfile","photoURL","name","nameDisplay","displayName","nameFirst","contact","contactEmail","email","provider","providerData","collection","add","person","authenticationUserOnCreate","database","ref","key","databaseWrite","writeType","entity","branches","pointer","payload","mutateRequest","val","metadata","hotlineDepartment","branch","omit","days","match","length","time","dateEnd","epochToday","dayendEpoch","Date","get","hourStart","currentHour","activeReferenceHotline","once","then","value","twilioVoice","voiceResponse","dial","activeVolunteers","forEach","number","volunteer","contactPhone","response","send","toString","twilioSmsMonitorOutbound","generate","smsRequest","timestamp","dataKey","twilioSyncCalls","calls","each","direction","call","duration","forwardedFrom","from","fromFormatted","endTime","phoneNumberSid","startTime","status","to","toFormatted","price","twilioSyncMessages","messages","body","message","errorCode","errorMessage","numMedia","sid","priceUnit","uri"],"mappings":"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","file":"index.js","sourcesContent":["/* ------------------------ External Dependencies ------------------------ */\nconst _ = require('lodash')\nconst functions = require('firebase-functions');\nconst admin = require('firebase-admin');\nconst stripe = require('stripe');\nconst twilio = require('twilio');\nconst VoiceResponse = require('twilio').twiml.VoiceResponse;\nconst shortid = require('shortid'); // https://www.npmjs.com/package/shortid\nconst moment = require('moment-timezone')\n/* ------------------------- Internal Dependencies -------------------------- */\nconst db = require('./database');\nimport setupGraphQLServer from './graphql'\nimport { twilioTextSend } from './twilio'\nimport { transformUserOnCreate } from './schema/transform'\n/*--- Third-Party Integrations ---*/\nimport todayEpoch from './timewatch/todayEpoch'\nimport todayMatch from './timewatch/todayMatch'\n/* ------------------------ Initialize Dependencies ------------------------- */\nadmin.initializeApp(functions.config().firebase);\nconst firestore = admin.firestore();\nconst accountSid = functions.config().twilio.accountsid\nconst authToken = functions.config().twilio.authtoken\nconst twilioClient = new twilio(accountSid, authToken);\n/*---*---------------              ---------------*---* \n                         GraphQL \n/*---*---------------              ---------------*---*/\nconst graphQLServer = setupGraphQLServer()\nexports.api = functions.https.onRequest(graphQLServer)\n\n/*---*---------------              ---------------*---* \n                      Authentication \n/*---*---------------              ---------------*---*/\nexports.authenticationComplete = functions.auth.user().onCreate(event => {\n  const person = {\n    uid: event.data.uid,\n    images: {\n      imageProfile: event.data.photoURL\n    },\n    name: {\n      nameDisplay: event.data.displayName,\n      nameFirst: event.data.displayName,\n    },\n    contact: {\n      contactEmail: event.data.email,\n    },\n    provider: event.data.providerData,\n  }\n  firestore.collection('people').add(person)\n});\n\nexports.authenticationUserOnCreate = functions.database.ref('/users/{user}')\n  .onCreate(event => {\n    const pointer = event.data.key \n\n    \n    db.databaseWrite({\n      config: {writeType: 'update'},\n      entity: 'users',\n      branches: [pointer],\n      payload: {pointer},\n    })\n  })\n\n/*---*---------------              ---------------*---* \n                         Mutate\n/*---*---------------              ---------------*---*/\nexports.mutateRequest = functions.database.ref('/mutate/request/{request}')\n\n  /*--- Monitor User Create | Insert additional User data.   (DB Middleware?)   ---*/\n  .onCreate(event => {\n    const eventKey = event.data.key \n    const data = event.data.val()\n\n    /* Entity | Target the requested entity to mutate */\n    if(data.metadata.entity) {\n      switch(data.metadata.entity) {\n\n        /* Volunter Hotline */\n        case('volunteerHotline'):\n          // TODO Add additional verification, besides just existing. It needs to match an enabled hotline.\n          if(data.metadata.hotlineDepartment)\n          {\n            db.databaseWrite({\n              config: {writeType: 'push'},\n              entity: 'volunteer',\n              branch: ['hotline', data.metadata.hotlineDepartment, 'storage'],\n              payload: _.omit(data.payload, 'userRequesting'),\n            })\n            const match = todayMatch(data.payload.days)\n            if (match.length){\n              const epochToday = todayEpoch(\"America/Los_Angeles\")\n              if (data.payload.time.dateEnd >= epochToday.dayendEpoch)\n              {\n                db.databaseWrite({\n                  config: {writeType: 'push'},\n                  entity: 'volunteer',\n                  branch: ['hotline', 'immigration', 'today'],\n                  payload: data.payload,\n                })\n\n                let currentHour = moment(new Date(),\"America/Los_Angeles\").get('hour'); const nextHour = currentHour + 1\n                if (data.payload.time.hourStart <= currentHour)\n                {\n                  const activeReferenceHotline = admin.database().ref('/volunteer/hotline/immigration/active')\n                  activeReferenceHotline.once('value').then(value => {\n                    let newValue = value.val()\n                    db.databaseWrite({\n                      config: {writeType: 'push'},\n                      entity: 'volunteer',\n                      branch: ['hotline', 'immigration', 'active'],\n                      payload: data.payload,\n                    })\n                  })\n                }\n              } \n            }\n          }\n          break;\n      }\n    }\n  })\n\n/* -------------------------------------------------------------------------- */\n/* ------------------------- External API Services -------------------------- */\n/* -------------------------------------------------------------------------- */\n\n/*---*---               ---*---* \n            Twilio\n            https://www.twilio.com/docs/api/twiml/client\n*---*---               ---*---*/\nexports.twilioVoice = functions.https.onRequest((request,response)=> {\n  const voiceResponse = new VoiceResponse();\n  const dial = voiceResponse.dial();\n  const activeReferenceHotline = admin.database().ref('/volunteer/hotline/immigration/active')\n  activeReferenceHotline.once('value').then(activeVolunteers => {\n    const data = activeVolunteers.val()\n    _.forEach(data, volunteer=>{\n      dial.number(`1${volunteer.contact.contactPhone}`)\n    })\n  response.send(voiceResponse.toString())\n  })\n})\n\nexports.twilioSmsMonitorOutbound = functions.database.ref('/infrastructure/messages/outbound/request/{messages}')\n  .onCreate(event => {\n      const dataKey = event.data.key // SMS Request Key | Generated by Firebase\n      const smsRequest = event.data.val(); // SMS Request Values | Latest Child from onCreate\n\n      /**\n       * @todo We need to add more PERMISSIONS CHECKS for SMS enhanced security.\n       * In addition the system should monitor for attempts to abuse SMS services, either by tracking volume or\n       * doing multiple verifications and looking for abnormalities in frontend/backend security checks.\n       * \n       * We trust cookies and Firebase, but \n       * \n       * Steps for Security\n       * 1. The Database rules limits who can write to the infrastructure \n       */\n      if (true) {      \n        const uid = shortid.generate(); // Universal Identification\n        smsRequest.metadata.uid = uid\n        smsRequest.metadata.timestamp = new Date()\n        /*--- DatabaseWrite | Infrastructure Communication Message Outbound Request ---*/ \n        /**\n         * Add a Universal Identifier to the Request\n         */\n        db.databaseWrite({\n          entity: 'infrastructure',\n          branch: ['messages', 'outbound', 'request', dataKey],\n          payload: {uid},\n          config: {\n            writeType: 'update'\n          }\n        })\n        \n        /**\n         * Log the SMS \n         */\n        db.databaseWrite({\n          entity: 'activity',\n          branch: ['sms'],\n          payload: {smsRequest},\n          config: {\n            writeType: 'push'\n          }\n        })\n\n        const payload = smsRequest.payload\n        twilioTextSend(uid, payload)\n      }\n  });\n\nexports.twilioSyncCalls = functions.https.onRequest((request,response)=> {\n  twilioClient.calls\n    .each((call) => {\n      const t = firestore.collection('calls').add({\n        direction: call.direction,\n        duration: call.duration,\n        forwardedFrom: call.forwardedFrom,\n        from: call.from,\n        fromFormatted: call.fromFormatted,\n        endTime: call.endTime,\n        phoneNumberSid: call. phoneNumberSid,\n        startTime: call.startTime,\n        status: call.status,\n        to: call.to,\n        toFormatted: call.toFormatted,\n        price: call.price,\n      })\n    });\n    response.send('Syncing Calls') \n})\n\nexports.twilioSyncMessages = functions.https.onRequest((request,response)=> {\n  twilioClient.messages\n    .each((message) => {\n      const t = firestore.collection('messages').add({\n        body: message.body,\n        direction: message.direction,\n        errorCode: message.errorCode,\n        errorMessage: message.errorMessage,\n        from: message.from,\n        numMedia: message.numMedia,\n        status: message.status,\n        sid: message.sid,\n        to: message.to,\n        price: message.price,\n        priceUnit: message.priceUnit,\n        uri: message.uri,\n      })\n    });\n})"]}