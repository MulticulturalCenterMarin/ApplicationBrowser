'use strict';var _graphql=require('./graphql'),_graphql2=_interopRequireDefault(_graphql),_transform=require('./schema/transform'),_todayEpoch=require('./timewatch/todayEpoch'),_todayEpoch2=_interopRequireDefault(_todayEpoch),_todayMatch=require('./timewatch/todayMatch'),_todayMatch2=_interopRequireDefault(_todayMatch);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require('lodash'),functions=require('firebase-functions'),admin=require('firebase-admin'),stripe=require('stripe'),twilio=require('twilio'),VoiceResponse=require('twilio').twiml.VoiceResponse,db=require('./database');admin.initializeApp(functions.config().firebase);var firestore=admin.firestore(),accountSid=functions.config().twilio.accountsid,authToken=functions.config().twilio.authtoken,graphQLServer=(0,_graphql2.default)();exports.api=functions.https.onRequest(graphQLServer),exports.authenticationComplete=functions.auth.user().onCreate(function(a){var b={uid:a.data.uid,images:{imageProfile:a.data.photoURL},name:{nameDisplay:a.data.displayName,nameFirst:a.data.displayName},contact:{contactEmail:a.data.email},provider:a.data.providerData};firestore.collection('people').add(b)}),exports.authenticationUserOnCreate=functions.database.ref('/users/{user}').onCreate(function(a){var b=a.data.key;db.databaseWrite({config:{writeType:'update'},entity:'users',branches:[b],payload:{pointer:b}})}),exports.mutateRequest=functions.database.ref('/mutate/request/{request}').onCreate(function(a){var b=a.data.key,c=a.data.val();if(c.metadata.entity)switch(c.metadata.entity){case'volunteerHotline':if(c.metadata.hotlineDepartment){db.databaseWrite({config:{writeType:'push'},entity:'volunteer',branch:['hotline',c.metadata.hotlineDepartment,'storage'],payload:_.omit(c.payload,'userRequesting')});var d=(0,_todayMatch2.default)(c.payload.days);if(d.length){var e=(0,_todayEpoch2.default)('America/Los_Angeles');if(c.payload.time.dateEnd>=e.dayendEpoch){db.databaseWrite({config:{writeType:'push'},entity:'volunteer',branch:['hotline','immigration','today'],payload:c.payload});var f=moment(new Date,'America/Los_Angeles').get('hour');if(c.payload.time.hourStart<=f){var h=admin.database().ref('/volunteer/hotline/immigration/active');h.once('value').then(function(i){i.val();db.databaseWrite({config:{writeType:'push'},entity:'volunteer',branch:['hotline','immigration','active'],payload:c.payload})})}}}}}}),exports.twilioVoice=functions.https.onRequest(function(a,b){var c=new VoiceResponse,d=c.dial(),e=admin.database().ref('/volunteer/hotline/immigration/active');e.once('value').then(function(f){var g=f.val();_.forEach(g,function(h){d.number('1'+h.contact.contactPhone)}),b.send(c.toString())})}),exports.hidden=functions.https.onRequest(function(){var c=new twilio(accountSid,authToken);c.calls.each(function(d){console.log(d);var e=firestore.collection('callRecords').add({direction:d.direction,duration:d.duration,forwardedFrom:d.forwardedFrom,from:d.from,fromFormatted:d.fromFormatted,endTime:d.endTime,startTime:d.startTime,price:d.price});console.log(e)})});
//# sourceMappingURL=index.js.map